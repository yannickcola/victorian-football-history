<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Club History Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        /* Custom styles to ensure the chart is responsive and the y-axis is inverted */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            max-width: 800px;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">Club Performance Tracker</h1>
            <p class="text-gray-600">Analyze the chronological history and ranking of your favorite club.</p>
        </header>

        <!-- Club Selection Dropdown -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <label for="club-select" class="block text-xl font-semibold text-gray-800 mb-3">Select a Club:</label>
            <select id="club-select" class="w-full md:w-1/2 p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                <option value="" disabled selected>-- Choose a Club --</option>
            </select>
        </div>

        <!-- Main Content Area (History Table and Chart) -->
        <div id="content-area" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- Club History Table -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Chronological History</h2>
                    <div id="history-table-container" class="overflow-x-auto">
                        <!-- Table will be rendered here -->
                        <table id="history-table" class="min-w-full divide-y divide-gray-200">
                            <!-- Table header and body content added by JavaScript -->
                        </table>
                    </div>
                </div>

                <!-- Ranking Chart -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex flex-col items-center">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 w-full">Ranking Over Time (Past 25 Years)</h2>
                    <div class="chart-container">
                        <canvas id="ranking-chart"></canvas>
                    </div>
                    <p class="text-sm text-gray-500 mt-4">Lower position numbers (closer to 1) indicate a better ranking, hence the inverted Y-axis.</p>
                </div>
            </div>
        </div>
        
        <!-- Initial Message / Loading Indicator -->
        <div id="initial-message" class="text-center text-gray-500 p-10 bg-white rounded-xl shadow-lg">
            <p class="text-lg">Please select a club from the dropdown above to view its history and ranking chart.</p>
        </div>
        <div id="error-message" class="hidden text-center text-red-600 p-4 bg-red-100 rounded-xl shadow-lg mt-4">
            <p class="font-semibold">Error loading data. Please ensure 'club_data.json' is available.</p>
        </div>

    </div>

    <script>
        // Global variables
        let clubData = {};
        let rankingChartInstance = null;
        const CHART_YEAR_RANGE = 25; // Define the range for the chart

        const clubSelect = document.getElementById('club-select');
        const contentArea = document.getElementById('content-area');
        const initialMessage = document.getElementById('initial-message');
        const errorMessage = document.getElementById('error-message');
        const historyTableContainer = document.getElementById('history-table-container');

        // Function to fetch the JSON data
        async function fetchClubData() {
            try {
                // Fetch the locally defined JSON file
                const response = await fetch('club_data.json'); 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                clubData = await response.json();
                populateDropdown(clubData);
                errorMessage.classList.add('hidden');
            } catch (error) {
                console.error("Could not fetch club data:", error);
                errorMessage.classList.remove('hidden');
            }
        }

        // Function to populate the dropdown
        function populateDropdown(data) {
            const clubNames = Object.keys(data).sort();
            clubNames.forEach(clubName => {
                const option = document.createElement('option');
                option.value = clubName;
                option.textContent = clubName;
                clubSelect.appendChild(option);
            });
            // Show the dropdown if data loaded successfully
            clubSelect.disabled = false;
        }

        // Function to handle club selection and display data
        function handleClubSelection(event) {
            const clubName = event.target.value;
            if (!clubName) return;

            // Hide initial message and show content area
            initialMessage.classList.add('hidden');
            contentArea.classList.remove('hidden');

            const history = clubData[clubName] || [];
            
            displayHistoryTable(history);
            displayRankingChart(history, clubName);
        }

        // Function to display the chronological history table
        function displayHistoryTable(history) {
            const table = document.getElementById('history-table');
            // Clear previous content
            historyTableContainer.innerHTML = '';
            
            if (history.length === 0) {
                historyTableContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No history data available for this club.</p>';
                return;
            }

            // Create table structure
            const tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tier</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">League</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                        </tr>
                    </thead>
                    <tbody id="history-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            `;
            historyTableContainer.innerHTML = tableHTML;
            const tbody = document.getElementById('history-body');

            // Sort history chronologically (ascending year)
            const sortedHistory = [...history].sort((a, b) => a.Year - b.Year);

            // Populate table rows
            sortedHistory.forEach(record => {
                const tierColor = getTierColor(record.Tier);
                const row = document.createElement('tr');
                row.classList.add('hover:bg-indigo-50');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.Year}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs font-medium ${tierColor}">Tier ${record.Tier}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.League}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">${record.Position}${getOrdinal(record.Position)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Helper function for styling tiers
        function getTierColor(tier) {
            switch (tier) {
                case 1: return 'bg-yellow-100 text-yellow-800';
                case 2: return 'bg-blue-100 text-blue-800';
                case 3: return 'bg-green-100 text-green-800';
                case 4: return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Helper function for ordinal suffix
        function getOrdinal(n) {
            if (n > 3 && n < 21) return 'th';
            switch (n % 10) {
                case 1: return "st";
                case 2: return "nd";
                case 3: return "rd";
                default: return "th";
            }
        }


        // Function to display the ranking chart
        function displayRankingChart(history, clubName) {
            const canvas = document.getElementById('ranking-chart');
            
            // Filter history for the last 25 years (or all if less)
            const currentYear = new Date().getFullYear();
            const startYear = currentYear - CHART_YEAR_RANGE;
            
            const relevantHistory = [...history]
                .filter(r => r.Year >= startYear)
                .sort((a, b) => a.Year - b.Year);
                
            // Extract labels (Years) and data (Positions)
            const labels = relevantHistory.map(r => r.Year);
            const data = relevantHistory.map(r => r.Position);
            
            // Find the worst (highest number) position to set the Y-axis scale
            // If the data is empty, default max position to 12 (based on CSV snippet)
            const maxPosition = data.length > 0 ? Math.max(...data) : 12;

            // Destroy previous chart instance if it exists
            if (rankingChartInstance) {
                rankingChartInstance.destroy();
            }

            rankingChartInstance = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${clubName} Final Position`,
                        data: data,
                        borderColor: '#4f46e5', // Indigo-600
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.3, // Curve the line slightly
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allows chart-container height to take effect
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        title: {
                            display: false,
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Season Year'
                            },
                            ticks: {
                                // Only show ticks for years where data exists
                                autoSkip: true,
                                maxTicksLimit: 15
                            }
                        },
                        y: {
                            // Invert the Y-axis so Position 1 is at the top (best performance)
                            reverse: true,
                            min: 1, // Minimum position is 1st
                            max: maxPosition + 1, // Set maximum slightly higher than the worst recorded position
                            ticks: {
                                stepSize: 1,
                                precision: 0,
                                callback: function(value, index, ticks) {
                                    // Ensure only integer positions are shown
                                    if (Math.floor(value) === value) {
                                        return value;
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'League Position (Lower is Better)'
                            }
                        }
                    },
                    tooltip: {
                         callbacks: {
                            title: function(context) {
                                return `Season: ${context[0].label}`;
                            },
                            label: function(context) {
                                const position = context.parsed.y;
                                return `Final Position: ${position}${getOrdinal(position)}`;
                            }
                        }
                    }
                }
            });
        }

        // Event listener for dropdown change
        clubSelect.addEventListener('change', handleClubSelection);

        // Initialize the application
        fetchClubData();

    </script>
</body>
</html>